## Part 1. Инструмент ipcalc
### 1.1. Сети и маски
1) Адрес сети 192.167.38.54/13
`ipcalc 192.167.38.54/13` \
![01-01](images/01-01.png)

2.1 Перевод маски 255.255.255.0 в префиксную и двоичную запись \
`ipcalc 255.255.255.0` \
![01-02](images/01-02.png) \
Netmask:   255.255.255.0 = 24   11111111.11111111.11111111. 00000000

2.2 /15 в обычную и двоичную \
`ipcalc 0.0.0.0/15` \
![alt text](images/01-03.png) \
Netmask:   255.254.0.0 = 15     11111111.1111111 0.00000000.00000000

2.3 11111111.11111111.11111111.11110000 в обычную и префиксную
`ipcalc 0.0.0.0/28` \
![alt text](images/01-04.png) \
Netmask:   255.255.255.240 = 28 11111111.11111111.11111111.1111 0000

3) Минимальный и максимальный хост в сети 12.167.38.4 при масках: 

> /8 

`ipcalc 12.167.38.4/8` \
![01-05](images/01-05.png) \
HostMin:   12.0.0.1             00001100. 00000000.00000000.00000001 \
HostMax:   12.255.255.254       00001100. 11111111.11111111.11111110 

> 11111111.11111111.00000000.00000000 

`ipcalc 12.167.38.4/16` \
![01-06](images/01-06.png) \
HostMin:   12.167.0.1           00001100.10100111. 00000000.00000001 \
HostMax:   12.167.255.254       00001100.10100111. 11111111.11111110

> 255.255.254.0 

`ipcalc 12.167.38.4/255.255.254.0` \
![01-07](images/01-07.png) \
HostMin:   12.167.38.1          00001100.10100111.0010011 0.00000001 \
HostMax:   12.167.39.254        00001100.10100111.0010011 1.11111110

> /4 

`ipcalc 12.167.38.4/4` \
![01-08](images/01-08.png) \
HostMin:   0.0.0.1              0000 0000.00000000.00000000.00000001 \
HostMax:   15.255.255.254       0000 1111.11111111.11111111.11111110

### 1.2. localhost

В контексте IP-адресации, localhost обычно ассоциируется с IP-адресом 127.0.0.1 для IPv4. 

к `127.0.0.2, 127.1.0.1` обратиться можно, а к `194.34.23.100, 128.0.0.1` нельзя

IP-адрес localhost находится в диапазоне адресов 127.0.0.0/8. Все адреса от 127.0.0.0 до 127.255.255.255 могут использоваться для обращения к самому себе в рамках одной и той же машины. Стандарт RFC 6890.


### 1.3. Диапазоны и сегменты сетей

1) Какие из перечисленных IP можно использовать в качестве публичного, а какие только в качестве частных.

> частные ip 

10.0.0.45/8 \
192.168.4.2/16 \
172.20.250.4/12 \
172.16.255.255/12 \
10.10.10.10/8

> публичные ip 

134.43.0.2/16 \
172.0.2.1/12 \
192.172.0.1/12 \
172.68.0.2/12 \
192.169.168.1/16 


2) Какие из перечисленных IP адресов шлюза возможны у сети 10.10.0.0/18: 

> возможны  

10.10.0.2 \
10.10.10.10 \
10.10.1.255 

> невозможны 

10.0.0.1 \
10.10.100.1

## Part 2. Статическая маршрутизация между двумя машинами

С помощью команды ip a посмотри существующие сетевые интерфейсы.


`ip a` \
![02-02](images/02-01.png)



![02-04](images/02-02.png)

Задаем следующие адреса и маски: ws1 - 192.168.100.10, маска /16, ws2 - 172.24.116.8, маска /12.


`sudo vim /etc/netplan/00-installer-config.yaml` \
![02-01](images/02-03.png)

`sudo netplan apply` \
`ip a` \
![02-03](images/02-01.png)


`sudo vim /etc/netplan/00-installer-config.yaml` \
![02-05](images/02-04.png)

`sudo netplan apply` \
`ip a` \
![02-06](images/02-02.png)


### 2.1. Добавление статического маршрута вручную

Добавь статический маршрут от одной машины до другой и обратно при помощи команды вида ip r add.



`sudo ip route 192.168.0.0/16 dev enp7s0` \
![02-07](images/02-05.png)


`sudo ip route add 172.16.0.0/12 dev enp7s0` \
![02-08](images/02-06.png)

### 2.2. Добавление статического маршрута с сохранением

Добавь статический маршрут от одной машины до другой.


`sudo vim /etc/netplan/00-installer-config.yaml`\
![02-09](images/02-07.png)



`sudo vim /etc/netplan/00-installer-config.yaml` \
![02-10](images/02-08.png)

Пропингуем соединение между машинами. \
![02-11](images/02-09.png) \
![02-12](images/02-10.png)


## Part 3. Утилита iperf3

### 3.1. Скорость соединения

```
8 Mbps = 1 MB/s(мегабит/c в мегабайт/c)
 
100 MB/s = 819200 Kbps(мегабайт/c в килобит/c)
 
1 Gbps = 1024 Mbps(гигабит/c в мегабит/c)
```

### 3.2. Утилита iperf3

Установили `sudo apt install iperf3`
Измерь скорость соединения между ws1 и ws2.

На ws1 делаем `iperf3 -s` \
![02-13](images/03-01.png)

На ws2 делаем `iperf3 -c 172.24.116.8` \
![02-14](images/03-02.png)

## Part 4. Сетевой экран

### 4.1. Утилита **iptables**

* открыть на машинах доступ для порта 22 (ssh) и порта 80 (http) 

> ws1
* в начале пишется запрещающее правило, а в конце пишется разрешающее правило

`sudo vim /etc/firewall.sh` \
![04-01](images/04-01.png)

> ws2
* в начале пишется разрешающее правило, а в конце пишется запрещающее правило

`sudo vim /etc/firewall.sh` \
![04-02](images/04-02.png)

`iptables -F` - используется для очистки (flush) всех правил в таблицах iptables. \
`iptables -X` - используется для удаления всех пользовательских цепочек (custom chains) в таблицах iptables. \
`iptables -A INPUT -p tcp --dport 22 -j ACCEPT` - команда добавляет правило в таблицу iptables, которое разрешает (ACCEPT) входящий TCP-трафик, направленный на порт 22 (SSH). Это позволяет клиентам подключаться к серверу по протоколу SSH. \
`iptables -A INPUT -p tcp --dport 80 -j ACCEPT` - команда добавляет правило в таблицу iptables, которое разрешает (ACCEPT) входящий TCP-трафик, направленный на порт 80 (HTTP). \
`iptables -A OUTPUT -p icmp --icmp-type echo-reply -j DROP` - команда добавляет правило в таблицу iptables, которое блокирует (DROP) исходящий ICMP-трафик типа "echo-reply" (ответ на запрос PING). Хост не будет отвечать на запросы ping. \
`iptables -A OUTPUT -p icmp --icmp-type echo-reply -j ACCEPT` - эта команда добавляет правило в таблицу iptables, которое разрешает (ACCEPT) исходящий ICMP-трафик типа "echo-reply" (ответ на запрос ping).

`sudo chmod +x /etc/firewall.sh` и `sudo /bin/bash /etc/firewall.sh`

![04-03](images/04-03.png) \
![04-04](images/04-04.png) \


### 4.2. Утилита **nmap**
```
утилита nmap - утилита для сканирования портов. 
```
Запускаем утилиту nmap командой (для проверки ищем в выводе nmap наличие строки Host is up) \
`nmap 172.24.116.8` \
![04-05](images/04-05.png)

## Part 5. Статическая маршрутизация сети

### 5.1. Настройка адресов машин

![05-01](images/05-01.png) 


`sudo vim /etc/netplan/00-installer-config.yaml` \
![05-02](images/05-02.png) \
`sudo netplan apply` \
`ip -4 a` \
![05-07](images/05-07.png)


`sudo vim /etc/netplan/00-installer-config.yaml` \
![05-03](images/05-03.png) \
`sudo netplan apply` \
`ip -4 a` \
![05-08](images/05-08.png)


`sudo vim /etc/netplan/00-installer-config.yaml` \
![05-04](images/05-04.png) \
`sudo netplan apply`\
`ip -4 a` \
![05-09](images/05-09.png)



`sudo vim /etc/netplan/00-installer-config.yaml` \
![05-05](images/05-05.png) \
`sudo netplan apply`\
`ip -4 a` \
![05-10](images/05-10.png)

`sudo vim /etc/netplan/00-installer-config.yaml` \
![05-06](images/05-06.png) \
`sudo netplan apply` \
`ip -4 a` \
![05-11](images/05-11.png)
##### Пропингуем ws22 с ws21. 

![05-12](images/05-12.png)
##### Пропингуем r1 с ws11.

![05-13](images/05-13.png)

### 5.2. Включение переадресации IP-адресов
##### Для включения переадресации IP, выполни команду на роутерах:
Для включения переадресации IP-адресов, выполняем команду \
`sysctl -w net.ipv4.ip_forward=1`


![05-14](images/05-14.png)


![05-15](images/05-15.png)

##### Открой файл */etc/sysctl.conf* и добавляем в него строку

`sudo vim /etc/sysctl.conf` 


![05-16](images/05-16.png)


![05-17](images/05-17.png)

### 5.3. Установка маршрута по-умолчанию
##### Добавляем `default` перед IP роутера в файле конфигураций.

`sudo vim /etc/netplan/00-installer-config.yaml` \
`ip r`


![05-18](images/05-18.png)  \
![05-21](images/05-21.png) 



![05-19](images/05-19.png) \
![05-22](images/05-22.png)  



![05-20](images/05-20.png)  \
![05-23](images/05-23.png) 

После на всех машинах применяем настройки. \
`sudo netplan apply`

##### Пингуем с ws11 роутер r2  
С ws11 ` ping 10.100.0.12` \
На r2 `sudo tcpdump -tn -i enp7s0` \
![05-24](images/05-24.png)

tcpdump позволяет прослушать порты и вывести на экран информацию с каких IP адресов приходят пакеты.

### 5.4. Добавление статических маршрутов
##### Добавим в роутеры r1 и r2 статические маршруты в файле конфигураций. 

`sudo vim /etc/netplan/00-installer-config.yaml` \
`ip r` \
`sudo netplan apply`

![05-25](images/05-25.png) \
![05-27](images/05-27.png) \
10.20.0.0/26 через 10.100.0.12 устройство enp8s0


![05-26](images/05-26.png) \
![05-28](images/05-28.png) \
10.10.0.0/18 через 10.100.0.11 устройство enp7s0

##### Запустим команды на ws11:
`ip r list 10.10.0.0/18` и `ip r list 0.0.0.0/0` \
![05-29](images/05-29.png) \
Т.к. машина ws11 соединена с сетью 10.10.0.0/18 по своему IP-адресу 10.10.0.2, то она идет по маршруту отличному от 0.0.0.0/0.

### 5.5. Построение списка маршрутизаторов

`sudo apt install traceroute`
##### Запускаем на r1 команду дампа:
`sudo tcpdump -tnv -i enp7s0` \
![05-30](images/05-30.png) \
Запускаем `traceroute 10.20.0.10` от ws11 до ws21. \
![05-31](images/05-31.png)

`-n` - не конвертировать адреса в имена; \
`-t` - не выводить время при выводе каждой строкчи дампа; \
`-v` - выводить более подробную информацию \
Команда `traceroute` linux использует UDP пакеты. Утилита посылает в направлении заданного хоста пакет с TTL=1, и ждет, от кого вернется ответ time exceeded. Отвечающий записывается как первый хоп (результат первого шага на пути к цели). Затем посылаются последовательно пакеты с TTL=2, 3, 4 и т.д. по порядку, пока при некотором значении TTL пакет не достигнет цели и не получит от нее ответ.

### 5.6. Использование протокола **ICMP** при маршрутизации
Запускаем на r1 перехват сетевого трафика и пингуем с ws11 несуществующий IP: \
`tcpdump -n -i enp7s0 icmp`
`ping -c 1 10.30.0.111`
![05-32](images/05-32.png)
![05-33](images/05-33.png)

## Part 6. Динамическая настройка IP с помощью **DHCP**

#### Для r2 настраеваем в файле */etc/dhcp/dhcpd.conf* конфигурацию службы **DHCP**
> r2

`sudo vim /etc/dhcp/dhcpd.conf` \
![06-01](images/06-01.png)

```
subnet 10.100.0.0 netmask 255.255.0.0 {}
Подсеть 10.100.0.0 с маской подсети 255.255.0.0
Эта запись определяет первую подсеть, но не содержит дополнительных параметров, таких как диапазон выдаваемых IP-адресов, шлюз или DNS-серверы.

subnet 10.20.0.0 netmask 255.255.255.192 {
range 10.20.0.2 10.20.0.61;
option routers 10.20.0.1;
option domain-name-servers 10.20.0.1;
}
Подсеть 10.20.0.0 с маской подсети 255.255.255.192
Эта запись определяет вторую подсеть со следующими параметрами:
- Диапазон выдаваемых IP-адресов: от 10.20.0.2 до 10.20.0.61
- Шлюз по умолчанию: 10.20.0.1
- DNS-сервер: 10.20.0.1
```
##### В файле *resolv.conf* пропишим `nameserver 8.8.8.8`.

`sudo vim /etc/resolv.conf` \
![06-02](images/06-02.png)

  - Опция edns0 (Extension Mechanisms for DNS) указывает, что клиент поддерживает расширения протокола DNS.
   - Опция trust-ad указывает, что клиент будет доверять бит "Authenticated Data" (AD) в ответах DNS, означающий, что ответ был аутентифицирован.

> ws21 

`ip a` \
![06-03](images/06-03.png)

> ws22

`ip a` \
![06-04](images/06-04.png)

Пингуем ws22 с ws21 \
`ping 10.20.0.3` \
![06-05](images/06-05.png)

#### Указываем MAC адрес у ws11
> ws11

`sudo vim /etc/netplan/00-installer-config.yaml` \
![06-06](images/06-06.png)

##### Для r1 настраеваем аналогично r2, но делаем выдачу адресов с жесткой привязкой к MAC-адресу (ws11). 
> r1

`sudo vim /etc/dhcp/dhcpd.conf` \
![06-07](images/06-07.png)

> ws11

`ip a` \
![06-08](images/06-08.png) \
Пингуем с ws11 10.10.0.4\
`ping 10.10.0.1` \
![06-09](images/06-09.png)

##### Запроси с ws21 обновление ip адреса.
> ws21

#### до изменения ip
`ip a` \
![05-34](images/05-34.png)
#### после изменения ip

`sudo dhclient -r` \
`sudo dhclient -v` \
![06-11](images/06-11.png)

`-r` - удаляет текущий ip адрес 

```
option routers ip-address [, ip-address...]; - список IP адресов маршрутизаторов для клиентской сети. Маршрутизаторы должны быть перечислены в порядке предпочтительности.

option domain-name-servers ip-address [, ip-address...]; -список DNS серверов, доступных клиенту. Сервера должны быть перечислены в порядке предпочтительности.
```

## Part 7. **NAT**

#### В файле */etc/apache2/ports.conf* на ws22 и r1 изменяем строку `Listen 80` на `Listen 0.0.0.0:80`, то есть сделай сервер Apache2 общедоступным.
` sudo vim /etc/apache2/ports.conf`

> r1 

![07-02](images/07-02.png)

> ws22

![07-01](images/07-01.png)

##### Запусти веб-сервер Apache командой `service apache2 start` на ws22 и r1.

`service apache2 start` \
`sudo systemctl status apache2`
> r1 

![07-03](images/07-03.png)

> ws22

![07-04](images/07-04.png)

##### Добавь в фаервол на r2 правила

> r2

`sudo vim /etc/firewall.sh` \
![07-05](images/07-05.png)

`- iptables -F` - удаление правил в таблице filter \
`- iptables -F -t nat` - удаление правил в таблице "NAT" \
`- iptables --policy FORWARD DROP` - oтбрасывать все маршрутизируемые пакеты

`sudo chmod +x /etc/firewall.sh`

##### Пингуем с r1 - ws22

`ping 10.20.0.3` \
![07-06](images/07-06.png)

##### Добавим в файл ещё одно правило

`- A FORWARD` - разрешить маршрутизацию всех пакетов протокола ICMP
> r2

`sudo vim /etc/firewall.sh` \
![07-07](images/07-07.png)

`iptables -A FORWARD -p icmp -j ACCEPT` - команда добавляет правило в таблицу iptables, которое разрешает (ACCEPT) весь ICMP-трафик, проходящий через шлюз или маршрутизатор.
##### Пингуем с r1 - ws22

`ping 10.20.0.3` \
![07-08](images/07-08.png)

##### Добавим в файл ещё два правила
> r2

`sudo vim /etc/firewall.sh` \
![07-09](images/07-09.png)

`iptables -A FORWARD -m state --state ESTABLISHED -j ACCEPT` - команда добавляет правило в таблицу iptables, которое разрешает (ACCEPT) весь FORWARD-трафик, принадлежащий уже установленным сетевым соединениям. \
`iptables -A FORWARD -i enp7s0 -o enp8s0 -s 10.20.0.0/26 -j SNAT --to-source 10.100.0.12` - команда добавляет правило в таблицу iptables, которое выполняет SNAT (Source Network Address Translation) на трафике, проходящем через интерфейсы enp7s0 и enp8s0, с исходным IP-адресом из подсети 10.20.0.0/26. При этом IP-адрес источника будет заменен на 10.100.0.12. \
`iptables -t nat -A PREROUTING -i enp7s0 -p tcp --dport 8080 -j DNAT --to-destination 10.20.0.20:80` - команда добавляет правило в таблицу nat iptables, которое выполняет DNAT (Destination Network Address Translation) на трафике, поступающем на интерфейс enp7s0 по протоколу TCP с портом назначения 8080. Адрес назначения будет заменен на 10.20.0.20:80.

##### С ws22 подключиться к серверу Apache на r1 командой:
`telnet 10.100.0.11 80` \
![07-10](images/07-10.png)
##### С r1 подключиться к серверу Apache на ws22 командой `telnet` 
Обращаемся к 10.20.0.3 80 порту по 
`telnet 10.100.0.12 8080` \
![07-11](images/07-11.png)

## Part 8.

### Запускаем в r2 фаервол с правилами из Part 7  
![08-01](images/08-01.png)  
#### и запускаем его  
![08-02](images/08-02.png)  

#### Запустить веб-сервер Apache на ws22 только на localhost
#### вносим изменения в файл  
![08-03](images/08-03.png)  


* запускаем веб-сервер  
![08-04](images/08-04.png)  

### Воспользоваться Local TCP forwarding с ws21 до ws22, чтобы получить доступ к веб-серверу на ws22 с ws21  
#### воспользуемся командой `ssh -L [local_port]:localhost:[local_port] [remote_ip]`  
![08-05](images/08-05.png)


#### проверим с помощью команды `telnet 127.0.0.1 5555`  
![08-06](images/08-06.png)  


### Воспользоваться Remote TCP forwarding c ws11 до ws22, чтобы получить доступ к веб-серверу на ws22 с ws11  
#### воспользуемся командой `ssh -R [remote_port]:localhost:[local_port] [remote_ip]`  
![08-07](images/08-07.png)

#### проверим с помощью команды `telnet 127.0.0.1 22`  
![08-08](images/08-08.png)  
